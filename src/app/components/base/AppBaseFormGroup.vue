<template>
  <div id="form-group" :class="{ [spacingBottom]: !isNotHaveSpacing }">
    <label v-if="isNameAsLabel" :class="classLabel" :for="labelFor">{{ name }}</label>
    <slot
      :isError="!!error"
      :isValid="isInvalid"
      :classes="{ 'border border-solid border-red-600 rounded-lg': !!error, 'p-success': !isInvalid }"
    />

    <template v-if="isInvalid">
      <small class="text-red-600 text-xs font-medium mt-4">{{ message }}</small>
    </template>
  </div>
</template>

<script setup lang="ts">
// Constants
import { BaseValidation, ErrorObject } from '@vuelidate/core';

/**
 * @description Define the props interface
 */
interface IProps {
  classLabel?: string;
  isHideErrorMessage?: boolean;
  isNameAsLabel?: boolean;
  isNameAsPlaceholder?: boolean;
  isNotHaveSpacing?: boolean;
  labelFor?: string;
  name: string;
  spacingBottom?: string;
  validators: BaseValidation;
}

/**
 * @description Define props with default values and interfaces
 */
const props = withDefaults(defineProps<IProps>(), {
  classLabel: '',
  isHideErrorMessage: false,
  isNameAsLabel: false,
  isNameAsPlaceholder: false,
  isNotHaveSpacing: false,
  name: '',
  spacingBottom: '',
  validators: undefined,
});

/**
 * @description Check if the form is invalid
 */
const isInvalid = computed(() => props.validators.$dirty && props.validators.$invalid);

/**
 * @description Check the error message and retrieve the first error
 */
const error: ComputedRef<ErrorObject | null> = computed(() => {
  if (!props.validators && (props.validators as BaseValidation)?.$errors.length === 0) return null;

  return props.validators.$errors[0];
});

/**
 * @description Handle format error message should same as on the consants, Then don't forget to replace special character {attribute} with the value from the form
 */
const message: ComputedRef<string> = computed(() => {
  const errorValidator = error ? error?.value?.$validator : null;

  if (!errorValidator) return '';

  return replaceParams(VALIDATION_MESSAGE[errorValidator] ?? `Error : ${errorValidator}`, {
    attribute: props.name,
    ...error?.value?.$params,
  });
});
</script>
